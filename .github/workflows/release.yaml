name: Release combined blocklist

on:
  workflow_dispatch:
  push:
  schedule:
    - cron: "0 1 */15 * *"

env:
  BLOCKLIST_DNSCRYPT: "blocklist-dnscrypt.txt"
  BLOCKLIST_UNBOUND: "blocklist-unbound.conf"

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    defaults:
      run: { shell: bash }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compile blocklist
        run: |
          bash compile.bash

      - name: Grab date as tag
        run: |
          echo "TAG=$( date '+%Y-%m-%d.%H%M%S' )" >> "$GITHUB_ENV"

      # N.B. Remeber to set permission for github token
      # Settings > Actions > General > Workflow permissions
      - name: Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          tar caf - "$BLOCKLIST_DNSCRYPT" "$BLOCKLIST_UNBOUND" \
            | zstd -T0 -19 -o assets.tar.zst
          gh release create "$TAG" \
            --latest \
            --title "$TAG" \
            assets.tar.zst
